# Metrics Reference

This document describes all metrics emitted by Claude Code and collected by Claude Pulse.

## How Metrics Flow

1. **Claude Code** calculates metrics (tokens, cost, etc.) and sends them via OTLP to the OTel Collector
2. **OTel Collector** receives metrics and exports to Prometheus (and JSON files for backup)
3. **Prometheus** scrapes the OTel Collector every 15 seconds and stores metrics
4. **Grafana** queries Prometheus and displays dashboards

## Metrics Emitted by Claude Code

Claude Code emits **pre-calculated values**, not raw pricing rates. Cost calculations happen inside Claude Code based on token counts and model-specific rates.

### Core Metrics

| Metric | Type | Description | Labels |
|--------|------|-------------|--------|
| `claude_code.cost.usage` | Counter | Pre-calculated cost in USD | `model`, `session.id` |
| `claude_code.token.usage` | Counter | Token counts | `model`, `type`, `session.id` |
| `claude_code.session.count` | Counter | Session counter | `session.id` |
| `claude_code.active_time.total` | Counter | Active time in seconds | `type`, `session.id` |
| `claude_code.lines_of_code.count` | Counter | Lines modified | `type`, `session.id` |
| `claude_code.commit.count` | Counter | Git commits made | `session.id` |
| `claude_code.pull_request.count` | Counter | PRs created | `session.id` |
| `claude_code.code_edit_tool.decision` | Counter | Tool permission decisions | `tool_name`, `decision`, `language`, `source` |

### Label Values

**Token types (`type` label for token.usage):**
- `input` - Tokens sent to the model
- `output` - Tokens generated by the model
- `cacheRead` - Tokens read from prompt cache
- `cacheCreation` - Tokens used to create cache

**Models (`model` label):**
- `claude-haiku-4-5-20251001`
- `claude-sonnet-4-5-20250929`
- `claude-opus-4-5-20251101`

**Lines of code types (`type` label for lines_of_code.count):**
- `added` - Lines added
- `removed` - Lines removed

**Tool names (`tool_name` label):**
- `Edit` - File editing
- `Write` - File creation
- `NotebookEdit` - Jupyter notebook editing

**Decision (`decision` label):**
- `accept` - User accepted the tool action
- `reject` - User rejected the tool action

**Decision source (`source` label):**
- `config` - Auto-accepted via configuration
- `user_permanent` - User chose "always allow"
- `user_temporary` - User allowed once
- `user_abort` - User aborted
- `user_reject` - User rejected

## Prometheus Metric Names

In Prometheus/Grafana, metrics have a `claude_code_` namespace prefix added by the OTel Collector:

| Original Name | Prometheus Name |
|---------------|-----------------|
| `claude_code.cost.usage` | `claude_code_claude_code_cost_usage_USD_total` |
| `claude_code.token.usage` | `claude_code_claude_code_token_usage_tokens_total` |
| `claude_code.session.count` | `claude_code_claude_code_session_count_total` |
| `claude_code.active_time.total` | `claude_code_claude_code_active_time_total_seconds_total` |
| `claude_code.lines_of_code.count` | `claude_code_claude_code_lines_of_code_count_total` |

## Cost Calculation

**Important:** The cost metric is calculated by Claude Code itself, not by this monitoring setup. We simply display what Claude Code reports.

### How Claude Code Calculates Cost

Cost is computed per API request:

```
cost = (input_tokens × input_rate) + (output_tokens × output_rate)
     + (cache_read_tokens × cache_rate) + (cache_creation_tokens × cache_creation_rate)
```

### Token Rates (per million tokens)

| Model | Input | Output | Cache Read | Cache Creation |
|-------|-------|--------|------------|----------------|
| Claude Haiku 4.5 | $1.00 | $5.00 | $0.10 | $1.25 |
| Claude Sonnet 4.5 | $3.00 | $15.00 | $0.30 | $3.75 |
| Claude Opus 4.5 | $5.00 | $25.00 | $0.50 | $6.25 |

**Note:** These rates are hardcoded inside Claude Code. If Anthropic changes pricing, Claude Code would need to be updated for accurate cost tracking.

## Example Prometheus Queries

```promql
# Total cost
sum(max_over_time(claude_code_claude_code_cost_usage_USD_total[$__range]))

# Cost by model
sum by (model) (max_over_time(claude_code_claude_code_cost_usage_USD_total[$__range]))

# Token usage rate by type
sum(rate(claude_code_claude_code_token_usage_tokens_total[5m])) by (type)

# Active time in minutes
sum(max_over_time(claude_code_claude_code_active_time_total_seconds_total[$__range])) / 60

# Lines added
sum(max_over_time(claude_code_claude_code_lines_of_code_count_total{type="added"}[$__range]))

# Cache hit ratio
sum(claude_code_claude_code_token_usage_tokens_total{type="cacheRead"}) /
(sum(claude_code_claude_code_token_usage_tokens_total{type="input"}) +
 sum(claude_code_claude_code_token_usage_tokens_total{type="cacheRead"})) * 100
```

## Notes

- **For Max/Pro subscribers:** Cost is tracked but doesn't affect billing (included in subscription)
- **Prompt caching:** Cached content costs 10% of original price after first request
- **Hidden usage:** Background tasks (indexing, context) add ~10-20% to visible costs
- **Accuracy:** This is an estimate; for official billing, check [Claude Console](https://console.anthropic.com)
